const upload = document.getElementById('upload');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const placeholder = document.getElementById('placeholder');

const buttons = document.querySelectorAll('.btn');
const panel = document.getElementById('control-panel');
const panelTitle = document.getElementById('control-title');
const slider = document.getElementById('slider');
const saveBtn = document.getElementById('save');

let img = new Image();
let currentFilter = null;

// Mantém tamanho da img fixo do canvas
const CANVAS_WIDTH = 400;
const CANVAS_HEIGHT = 300;
canvas.width = CANVAS_WIDTH;
canvas.height = CANVAS_HEIGHT;

// Upload da imagem
upload.addEventListener('change', e => {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    img.src = reader.result;
    img.onload = () => {
      placeholder.style.display = 'none';
      canvas.style.display = 'block';
      drawImageScaled(img);
    };
  };
  reader.readAsDataURL(file);
});

// Função para redimensionar mantendo proporção
function drawImageScaled(img) {
  const hRatio = canvas.width / img.width;
  const vRatio = canvas.height / img.height;
  const ratio = Math.min(hRatio, vRatio);
  const centerShiftX = (canvas.width - img.width * ratio) / 2;
  const centerShiftY = (canvas.height - img.height * ratio) / 2;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(
    img,
    0,
    0,
    img.width,
    img.height,
    centerShiftX,
    centerShiftY,
    img.width * ratio,
    img.height * ratio
  );
}

// Mostrar barra de controle ao clicar no botão
buttons.forEach(button => {
  if (button.id !== 'save') {
    button.addEventListener('click', () => {
      panel.classList.remove('hidden');
      currentFilter = button.id;

      if (button.id === 'rotate') {
        slider.min = 0;
        slider.max = 360;
        slider.step = 1;
        slider.value = 0;
        panelTitle.textContent = 'Rotação (°)';
      } else if (button.id === 'brightness' || button.id === 'darken') {
        slider.min = 0;
        slider.max = 2;
        slider.step = 0.01;
        slider.value = 1;
        panelTitle.textContent = button.id === 'brightness' ? 'Brilho' : 'Escurecimento';
      } else {
        panel.classList.add('hidden');
        applyFilter(button.id);
      }
    });
  }
});

// Aplicar filtro 
slider.addEventListener('input', () => {
  if (currentFilter) applyFilter(currentFilter, parseFloat(slider.value));
});

function applyFilter(type, value = 1) {
  drawImageScaled(img);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;

  if (type === 'brightness' || type === 'darken') {
    for (let i = 0; i < data.length; i += 4) {
      data[i] *= value;
      data[i + 1] *= value;
      data[i + 2] *= value;
    }
  }

  if (type === 'grayscale') {
    for (let i = 0; i < data.length; i += 4) {
      const avg = 0.3 * data[i] + 0.59 * data[i + 1] + 0.11 * data[i + 2];
      data[i] = data[i + 1] = data[i + 2] = avg;
    }
  }

  ctx.putImageData(imageData, 0, 0);

  if (type === 'rotate') {
    const angle = (value * Math.PI) / 180;
    const tempCanvas = document.createElement('canvas');
    const tctx = tempCanvas.getContext('2d');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;

    tctx.translate(canvas.width / 2, canvas.height / 2);
    tctx.rotate(angle);
    drawImageScaled(img);
    tctx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(tempCanvas, 0, 0);
  }
}

//  Salvar imagem
saveBtn.addEventListener('click', () => {
  const link = document.createElement('a');
  link.download = 'imagem_editada.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
});

